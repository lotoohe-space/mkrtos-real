/**
 ******************************************************************************
 * @file
 * @author
 * @version
 * @date
 * @brief
 ******************************************************************************
 * @attention
 *
 *
 ******************************************************************************
 */
/* Includes ------------------------------------------------------------------*/
#include "nes_main.h"
#include "u_sleep.h"
/* Private define ------------------------------------------------------------*/
/* Private macro -------------------------------------------------------------*/
/* Private variables ---------------------------------------------------------*/
/* Private function prototypes -----------------------------------------------*/
/* Private functions ---------------------------------------------------------*/
uint8 Continue = TRUE; //????????
int FrameCnt;

/* NES ????????*/
void NesFrameCycle(void)
{
	int clocks; // CPU??????

	//// ?????????????????VROM????????????0???????VROM
	//	if ( NesHeader.byVRomSize == 0)
	//		????VROM?��??��?��?
	FrameCnt = 0;
	while (Continue)
	{
		/* scanline: 0~19 VBANK ?��???PPU???NMI????????NMI ?��?, */
		FrameCnt++; //???????
					//		printf("\r\n??????? %d", FrameCnt);
		SpriteHitFlag = FALSE;
		for (PPU_scanline = 0; PPU_scanline < 20; PPU_scanline++)
		{
			exec6502(CLOCKS_PER_SCANLINE);
			//			NesHBCycle();
		}
		/* scanline: 20, PPU??????????????��????????*/
		exec6502(CLOCKS_PER_SCANLINE);
		//		NesHBCycle();  //??????
		PPU_scanline++; // 20++
		PPU_Reg.R2 &= ~R2_SPR0_HIT;
		/* scanline: 21~261*/
		for (; PPU_scanline < SCAN_LINE_DISPALY_END_NUM; PPU_scanline++)
		{
			if ((SpriteHitFlag == TRUE) && ((PPU_Reg.R2 & R2_SPR0_HIT) == 0))
			{
				clocks = sprite[0].x * CLOCKS_PER_SCANLINE / NES_DISP_WIDTH;
				exec6502(clocks);
				PPU_Reg.R2 |= R2_SPR0_HIT;
				exec6502(CLOCKS_PER_SCANLINE - clocks);
			}
			else
			{
				exec6502(CLOCKS_PER_SCANLINE);
			}

			if (PPU_Reg.R1 & (R1_BG_VISIBLE | R1_SPR_VISIBLE))
			{ //????????????
				if (SpriteHitFlag == FALSE)
					NES_GetSpr0HitFlag(PPU_scanline - SCAN_LINE_DISPALY_START_NUM); //????Sprite #0 ??????
			}
			if (FrameCnt & 2)
			{																//?2???????
				NES_RenderLine(PPU_scanline - SCAN_LINE_DISPALY_START_NUM); //?????????????
			}
		}
		/* scanline: 262 ?????*/
		exec6502(CLOCKS_PER_SCANLINE);
		PPU_Reg.R2 |= R2_VBlank_Flag; //????VBANK ???
		/*?????PPU VBANK?��????????VBANK*/
		if (PPU_Reg.R0 & R0_VB_NMI_EN)
		{
			NMI_Flag = SET1; //???????�k????NMI?��?
		}

		/*?????IRQ????????????????APU??*/

		/* A mapper function in V-Sync ?��???��????VBANK???*/
		//		MapperVSync();

		/*?????????JoyPad??,????JoyPad???????*/
		//		NES_JoyPadUpdateValue();	 //systick ?��????????

		/*?????????????????????*/
		//		if(){
		//		 	Continue = FALSE;
		//		}
		u_sleep_ms(1);
	}
}

/**
 * @brief  NES_Main program.
 * @param  None
 * @retval None
 */
void nes_main(void)
{
	NesHeader *neshreader = (NesHeader *)rom_file;

	/* 	????NES??????????0x1A????????0x1a??Ctrl+Z,????????????????????
	 *	???????strcncmp????3??????
	 */
	if (strncmp(neshreader->filetype, "NES", 3) != 0)
	{
		printf("\r\n???��???????????????, NES??????????");
		return;
	}
	else
	{
		printf("\r\n?????????��?");
		printf("\r\n  16kB  ROM ?????: %d", neshreader->romnum);
		printf("\r\n   8kB VROM ?????: %d", neshreader->vromnum);
		if ((neshreader->romfeature & 0x01) == 0)
		{
			printf("\r\n  ??????");
		}
		else
		{
			printf("\r\n  ???????");
		}

		if ((neshreader->romfeature & 0x02) == 0)
		{
			printf("\r\n  ?????SRAM");
		}
		else
		{
			printf("\r\n  ?��???SRAM");
		}

		if ((neshreader->romfeature & 0x04) == 0)
		{
			printf("\r\n  ??512????trainer($7000-$71FF)");
		}
		else
		{
			printf("\r\n  ??512????trainer(ROM?????????)");
		}

		if ((neshreader->romfeature & 0x08) == 0)
		{
			printf("\r\n  2???VRAM????");
		}
		else
		{
			printf("\r\n  4???VRAM????(??????)");
		}

		printf("\r\n  iNES Mapper Numbers: %d", (neshreader->rommappernum & 0xF0) | (neshreader->romfeature >> 4));
	}

	/*
	 *?????nes ?????
	 */
	init6502mem(0,					 /*exp_rom*/
				0,					 /*sram ??????????, ??????*/
				(&rom_file[0x10]),	 /*prg_rombank, ?��????�� ??????????*/
				neshreader->romnum); //?????6502?��??????
	reset6502();
	PPU_Init((&rom_file[0x10] + (neshreader->romnum * 0x4000)), (neshreader->romfeature & 0x01)); /*PPU_?????*/
	NES_JoyPadInit();
	/*
	 *nes ????????????
	 */
	NesFrameCycle();
}
/**
 * @}
 */

/*******************************END OF FILE***********************************/
